<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:ShareX.Editor.ViewModels"
             xmlns:views="using:ShareX.Editor.Views"
             xmlns:models="using:ShareX.Editor.Annotations"
             xmlns:converters="using:ShareX.Editor.Converters"
             xmlns:helpers="using:ShareX.Editor.Helpers"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
             x:Class="ShareX.Editor.Views.EditorView"
             Focusable="True"
             KeyDown="OnKeyDown">

    <UserControl.Resources>
        <converters:DoubleToCornerRadiusConverter x:Key="DoubleToCornerRadius" />
        <FontFamily x:Key="FontAwesome">avares://ShareX.Editor/Assets#Font Awesome 7 Free</FontFamily>
        <x:String x:Key="IconSelect">&#xf25a;</x:String>
        <x:String x:Key="IconRectangle">&#xf0c8;</x:String>
        <x:String x:Key="IconEllipse">&#xf111;</x:String>
        <x:String x:Key="IconLine">&#xf068;</x:String>
        <x:String x:Key="IconArrow">&#xf061;</x:String>
        <x:String x:Key="IconPen">&#xf304;</x:String>
        <x:String x:Key="IconHighlighter">&#xf591;</x:String>
        <x:String x:Key="IconText">&#xf031;</x:String>
        <x:String x:Key="IconSpeechBalloon">&#xf4ad;</x:String>
        <x:String x:Key="IconNumber">&#xf0cb;</x:String>
        <x:String x:Key="IconBlur">&#xf1fc;</x:String>
        <x:String x:Key="IconPixelate">&#xf009;</x:String>
        <x:String x:Key="IconMagnify">&#xf00e;</x:String>
        <x:String x:Key="IconSpotlight">&#xf0eb;</x:String>
        <x:String x:Key="IconSmartEraser">&#xf12d;</x:String>
        <x:String x:Key="IconCrop">&#xf125;</x:String>
        <x:String x:Key="IconCutOut">&#xf0c4;</x:String>
        <x:String x:Key="IconEffects">&#xf0d0;</x:String>
        <x:String x:Key="IconUndo">&#xf0e2;</x:String>
        <x:String x:Key="IconRedo">&#xf01e;</x:String>
        <x:String x:Key="IconClear">&#xf12d;</x:String>
        <x:String x:Key="IconDelete">&#xf2ed;</x:String>
        <x:String x:Key="IconCopy">&#xf0c5;</x:String>
        <x:String x:Key="IconSave">&#xf0c7;</x:String>
        <x:String x:Key="IconDownload">&#xf019;</x:String>
        <x:String x:Key="IconZoomIn">&#xf00e;</x:String>
        <x:String x:Key="IconZoomOut">&#xf010;</x:String>
    </UserControl.Resources>

    <UserControl.Styles>
        <!-- Style for Output Ratio buttons -->
        <Style Selector="Button.ratio-button">
            <Setter Property="Background" Value="#2D2D3F"/>
            <Setter Property="BorderBrush" Value="#3B3B52"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Foreground" Value="#94A3B8"/>
            <Setter Property="Padding" Value="8,6"/>
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="FontSize" Value="12"/>
        </Style>
        <Style Selector="Button.ratio-button.active">
            <Setter Property="Background">
                <Setter.Value>
                    <LinearGradientBrush StartPoint="0%,0%" EndPoint="100%,100%">
                        <GradientStop Color="#8B5CF6" Offset="0"/>
                        <GradientStop Color="#9333EA" Offset="1"/>
                    </LinearGradientBrush>
                </Setter.Value>
            </Setter>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
        </Style>
    </UserControl.Styles>

    <Grid RowDefinitions="Auto,*,Auto">
        <!-- Row 0: Annotation Toolbar (always visible) -->
        <Border Grid.Row="0" 
                Padding="12,8">
            <StackPanel Orientation="Vertical" Spacing="10">
                <!-- Row 1: Tools only -->
                <Border BorderThickness="0,0,0,1" BorderBrush="#3B3B52" Padding="0,0,0,8">
                    <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <Button Classes="ratio-button"
                                    Classes.active="{Binding ActiveTool, Converter={StaticResource EqualsConverter}, ConverterParameter=Select}"
                                    Width="40" Height="40"
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.Select}"
                                    ToolTip.Tip="Select (V)"
                                    FontFamily="{StaticResource FontAwesome}" FontWeight="Black" FontSize="16" Content="{StaticResource IconSelect}"/>
                            <Button Classes="ratio-button"
                                    Classes.active="{Binding ActiveTool, Converter={StaticResource EqualsConverter}, ConverterParameter=Rectangle}"
                                    Width="40" Height="40"
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.Rectangle}"
                                    ToolTip.Tip="Rectangle (R)"
                                    FontFamily="{StaticResource FontAwesome}" FontWeight="Black" FontSize="16" Content="{StaticResource IconRectangle}"/>
                            <Button Classes="ratio-button"
                                    Classes.active="{Binding ActiveTool, Converter={StaticResource EqualsConverter}, ConverterParameter=Ellipse}"
                                    Width="40" Height="40"
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.Ellipse}"
                                    ToolTip.Tip="Ellipse (E)"
                                    FontFamily="{StaticResource FontAwesome}" FontWeight="Black" FontSize="16" Content="{StaticResource IconEllipse}"/>
                            <Button Classes="ratio-button"
                                    Classes.active="{Binding ActiveTool, Converter={StaticResource EqualsConverter}, ConverterParameter=Line}"
                                    Width="40" Height="40"
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.Line}"
                                    ToolTip.Tip="Line (L)"
                                    FontFamily="{StaticResource FontAwesome}" FontWeight="Black" FontSize="16" Content="{StaticResource IconLine}"/>
                            <Button Classes="ratio-button"
                                    Classes.active="{Binding ActiveTool, Converter={StaticResource EqualsConverter}, ConverterParameter=Arrow}"
                                    Width="40" Height="40"
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.Arrow}"
                                    ToolTip.Tip="Arrow (A)"
                                    FontFamily="{StaticResource FontAwesome}" FontWeight="Black" FontSize="16" Content="{StaticResource IconArrow}"/>
                            <Button Classes="ratio-button"
                                    Classes.active="{Binding ActiveTool, Converter={StaticResource EqualsConverter}, ConverterParameter=Pen}"
                                    Width="40" Height="40"
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.Pen}"
                                    ToolTip.Tip="Freehand (P)"
                                    FontFamily="{StaticResource FontAwesome}" FontWeight="Black" FontSize="16" Content="{StaticResource IconPen}"/>
                            <Button Classes="ratio-button"
                                    Classes.active="{Binding ActiveTool, Converter={StaticResource EqualsConverter}, ConverterParameter=Highlighter}"
                                    Width="40" Height="40"
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.Highlighter}"
                                    ToolTip.Tip="Highlighter (H)"
                                    FontFamily="{StaticResource FontAwesome}" FontWeight="Black" FontSize="16" Content="{StaticResource IconHighlighter}"/>
                            <Button Classes="ratio-button"
                                    Classes.active="{Binding ActiveTool, Converter={StaticResource EqualsConverter}, ConverterParameter=Text}"
                                    Width="40" Height="40"
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.Text}"
                                    ToolTip.Tip="Text (T)"
                                    FontFamily="{StaticResource FontAwesome}" FontWeight="Black" FontSize="16" Content="{StaticResource IconText}"/>
                            <Button Classes="ratio-button"
                                    Classes.active="{Binding ActiveTool, Converter={StaticResource EqualsConverter}, ConverterParameter=SpeechBalloon}"
                                    Width="40" Height="40"
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.SpeechBalloon}"
                                    ToolTip.Tip="Speech Balloon (B)"
                                    FontFamily="{StaticResource FontAwesome}" FontWeight="Black" FontSize="16" Content="{StaticResource IconSpeechBalloon}"/>
                            <Button Classes="ratio-button"
                                    Classes.active="{Binding ActiveTool, Converter={StaticResource EqualsConverter}, ConverterParameter=Number}"
                                    Width="40" Height="40"
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.Number}"
                                    ToolTip.Tip="Step/Number (N)"
                                    FontFamily="{StaticResource FontAwesome}" FontWeight="Black" FontSize="16" Content="{StaticResource IconNumber}"/>
                            <Button Classes="ratio-button"
                                    Classes.active="{Binding ActiveTool, Converter={StaticResource EqualsConverter}, ConverterParameter=Blur}"
                                    Width="40" Height="40"
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.Blur}"
                                    ToolTip.Tip="Blur Region"
                                    FontFamily="{StaticResource FontAwesome}" FontWeight="Black" FontSize="16" Content="{StaticResource IconBlur}"/>
                            <Button Classes="ratio-button"
                                    Classes.active="{Binding ActiveTool, Converter={StaticResource EqualsConverter}, ConverterParameter=Pixelate}"
                                    Width="40" Height="40"
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.Pixelate}"
                                    ToolTip.Tip="Pixelate Region"
                                    FontFamily="{StaticResource FontAwesome}" FontWeight="Black" FontSize="16" Content="{StaticResource IconPixelate}"/>
                            <Button Classes="ratio-button"
                                    Classes.active="{Binding ActiveTool, Converter={StaticResource EqualsConverter}, ConverterParameter=Magnify}"
                                    Width="40" Height="40"
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.Magnify}"
                                    ToolTip.Tip="Magnifier (M)"
                                    FontFamily="{StaticResource FontAwesome}" FontWeight="Black" FontSize="16" Content="{StaticResource IconMagnify}"/>
                            <Button Classes="ratio-button"
                                    Classes.active="{Binding ActiveTool, Converter={StaticResource EqualsConverter}, ConverterParameter=Spotlight}"
                                    Width="40" Height="40"
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.Spotlight}"
                                    ToolTip.Tip="Spotlight (S)"
                                    FontFamily="{StaticResource FontAwesome}" FontWeight="Black" FontSize="16" Content="{StaticResource IconSpotlight}"/>
                            <Button Classes="ratio-button"
                                    Classes.active="{Binding ActiveTool, Converter={StaticResource EqualsConverter}, ConverterParameter=SmartEraser}"
                                    Width="40" Height="40"
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.SmartEraser}"
                                    ToolTip.Tip="Smart Eraser"
                                    FontFamily="{StaticResource FontAwesome}" FontWeight="Black" FontSize="16" Content="{StaticResource IconSmartEraser}"/>
                            <Button Classes="ratio-button"
                                    Classes.active="{Binding ActiveTool, Converter={StaticResource EqualsConverter}, ConverterParameter=Crop}"
                                    Width="40" Height="40"
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.Crop}"
                                    ToolTip.Tip="Crop (C)"
                                    FontFamily="{StaticResource FontAwesome}" FontWeight="Black" FontSize="16" Content="{StaticResource IconCrop}"/>
                            <Button Classes="ratio-button"
                                    Classes.active="{Binding ActiveTool, Converter={StaticResource EqualsConverter}, ConverterParameter=CutOut}"
                                    Width="40" Height="40"
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.CutOut}"
                                    ToolTip.Tip="Cut Out (U)"
                                    FontFamily="{StaticResource FontAwesome}" FontWeight="Black" FontSize="16" Content="{StaticResource IconCutOut}"/>
                            <Button Classes="ratio-button"
                                    Classes.active="{Binding IsEffectsPanelOpen}"
                                    Width="40" Height="40"
                                    Command="{Binding ToggleEffectsPanelCommand}"
                                    ToolTip.Tip="Image Effects Panel (F)"
                                    FontFamily="{StaticResource FontAwesome}" FontWeight="Black" FontSize="16" Content="{StaticResource IconEffects}"/>
                        </StackPanel>
                    </ScrollViewer>
                </Border>

                <!-- Row 2: Tool options -->
                <StackPanel Orientation="Horizontal" Spacing="12">
                    <!-- Color Picker-->
                    <Border BorderThickness="0,0,1,0" BorderBrush="#3B3B52" Padding="0,0,12,0">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="Color" FontSize="11" Foreground="#94A3B8" VerticalAlignment="Center"/>
                            <ItemsControl ItemsSource="{x:Static vm:MainViewModel.ColorPalette}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel Orientation="Horizontal" Spacing="4"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Button Width="28" Height="28" Padding="0"
                                                Command="{Binding DataContext.SetColorCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding .}"
                                                Background="Transparent"
                                                BorderThickness="0">
                                            <Border Width="24" Height="24"
                                                    Background="{Binding .}"
                                                    CornerRadius="4"
                                                    BorderThickness="2">
                                                <Border.BorderBrush>
                                                    <MultiBinding Converter="{StaticResource SelectedColorToBorder}">
                                                        <Binding Path="DataContext.SelectedColor" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                        <Binding />
                                                    </MultiBinding>
                                                </Border.BorderBrush>
                                            </Border>
                                        </Button>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </Border>
                    
                    <!-- Stroke Width -->
                    <Border BorderThickness="0,0,1,0" BorderBrush="#3B3B52" Padding="0,0,12,0">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="Width" FontSize="11" Foreground="#94A3B8" VerticalAlignment="Center"/>
                            <ItemsControl ItemsSource="{x:Static vm:MainViewModel.StrokeWidths}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel Orientation="Horizontal" Spacing="4"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Button Classes="ratio-button" Width="32" Height="32"
                                                Command="{Binding DataContext.SetStrokeWidthCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding .}"
                                                ToolTip.Tip="{Binding ., StringFormat='{}{0}px'}">
                                            <Ellipse Width="{Binding .}" Height="{Binding .}" Fill="#94A3B8"/>
                                        </Button>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </Border>
                    
                    <!-- Undo/Redo -->
                    <Border BorderThickness="0,0,1,0" BorderBrush="#3B3B52" Padding="0,0,12,0">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                                <Button Classes="ratio-button" Width="32" Height="32"
                                    Command="{Binding UndoCommand}" ToolTip.Tip="Undo (Ctrl+Z)"
                                    FontFamily="{StaticResource FontAwesome}" FontWeight="Black" FontSize="14" Content="{StaticResource IconUndo}"/>
                                <Button Classes="ratio-button" Width="32" Height="32"
                                    Command="{Binding RedoCommand}" ToolTip.Tip="Redo (Ctrl+Shift+Z)"
                                    FontFamily="{StaticResource FontAwesome}" FontWeight="Black" FontSize="14" Content="{StaticResource IconRedo}"/>
                        </StackPanel>
                    </Border>
                    
                    <!-- Delete / Clear -->
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <Button Classes="ratio-button" Width="32" Height="32"
                                Command="{Binding ClearAnnotationsCommand}" ToolTip.Tip="Clear all annotations"
                                FontFamily="{StaticResource FontAwesome}" FontWeight="Black" FontSize="14" Content="{StaticResource IconClear}"/>
                        <Button Classes="ratio-button" Width="32" Height="32"
                                Command="{Binding DeleteSelectedCommand}" ToolTip.Tip="Delete Selected (Del)"
                                FontFamily="{StaticResource FontAwesome}" FontWeight="Black" FontSize="14" Content="{StaticResource IconDelete}"/>
                    </StackPanel>
                </StackPanel>
            </StackPanel>
        </Border>

        <!-- Row 1: Main Content Area with Preview and Sidebar -->
        <Grid Grid.Row="1" ColumnDefinitions="*,300">
            
            <!-- Central Preview Canvas -->
            <Grid Grid.Column="0" Margin="20">
                <ScrollViewer Name="CanvasScrollViewer"
                              Background="Transparent"
                              HorizontalScrollBarVisibility="Auto"
                              VerticalScrollBarVisibility="Auto"
                              PointerPressed="OnScrollViewerPointerPressed"
                              PointerMoved="OnScrollViewerPointerMoved"
                              PointerReleased="OnScrollViewerPointerReleased">
                    <LayoutTransformControl>
                        <LayoutTransformControl.LayoutTransform>
                            <ScaleTransform ScaleX="{Binding Zoom}" ScaleY="{Binding Zoom}" />
                        </LayoutTransformControl.LayoutTransform>
                        <Border x:Name="PreviewFrame"
                                IsVisible="{Binding HasPreviewImage}"
                                 HorizontalAlignment="Center"
                                 VerticalAlignment="Center"
                                 Background="{Binding CanvasBackground}"
                                 Padding="{Binding CanvasPadding}">
                            <!-- Outer Border: Shadow effect -->
                            <Border BoxShadow="{Binding CanvasShadow}"
                                   CornerRadius="{Binding CanvasCornerRadius, Converter={StaticResource DoubleToCornerRadius}}">
                                <!-- Padding Border: Uses top-left pixel color -->
                                <Border Background="{Binding SmartPaddingColor}"
                                        Padding="{Binding SmartPaddingThickness}"
                                        CornerRadius="{Binding CanvasCornerRadius, Converter={StaticResource DoubleToCornerRadius}}"
                                        ClipToBounds="True">
                                    <!-- Inner Border: White background only -->
                                    <Border Background="#FFFFFF">
                                        <Grid Name="CanvasContainer"
                                              Width="{Binding ImageWidth}"
                                              Height="{Binding ImageHeight}">
                                        
                                        <!-- Image Layer -->
                                        <Image Name="PreviewImageControl"
                                               Source="{Binding PreviewImage}"
                                               Stretch="Uniform"
                                               HorizontalAlignment="Stretch"
                                               VerticalAlignment="Stretch"/>

                                        <!-- Annotation Layer (Saved content) -->
                                        <Canvas Name="AnnotationCanvas"
                                                Background="Transparent"
                                                IsVisible="{Binding HasPreviewImage}"
                                                HorizontalAlignment="Stretch"
                                                VerticalAlignment="Stretch"
                                                Cursor="Cross"
                                                PointerPressed="OnCanvasPointerPressed"
                                                PointerMoved="OnCanvasPointerMoved"
                                                PointerReleased="OnCanvasPointerReleased">
                                        </Canvas>

                                        <!-- Overlay Layer (Transient UI: Selection handles, Crop) -->
                                        <Canvas Name="OverlayCanvas"
                                                IsHitTestVisible="True"
                                                HorizontalAlignment="Stretch"
                                                VerticalAlignment="Stretch"
                                                PointerPressed="OnCanvasPointerPressed"
                                                PointerMoved="OnCanvasPointerMoved"
                                                PointerReleased="OnCanvasPointerReleased">
                                            <Rectangle Name="CropOverlay" 
                                                       IsVisible="False"
                                                       Stroke="White"
                                                       StrokeThickness="2"
                                                       StrokeDashArray="4,2"
                                                       Fill="#80000000" />
                                        </Canvas>
                                    </Grid>
                                    </Border>
                                </Border>
                            </Border>
                        </Border>
                    </LayoutTransformControl>
                </ScrollViewer>
            </Grid>

            <!-- Right Sidebar (Settings Panel) -->
            <Border Grid.Column="1" Padding="20">
                <ScrollViewer Padding="0,0,40,0"
                              HorizontalScrollBarVisibility="Disabled"
                              VerticalScrollBarVisibility="Auto">
                     <StackPanel Spacing="25">
                        <TextBlock Text="Settings" 
                                   FontSize="18" 
                                   FontWeight="Bold" 
                                   Foreground="White"/>

                        <!-- Margin Slider -->
                        <StackPanel Spacing="8">
                            <Grid ColumnDefinitions="*,Auto">
                                <TextBlock Grid.Column="0" Text="Margin" Foreground="#9CA3AF"/>
                                <TextBlock Grid.Column="1" Text="{Binding PreviewPadding, StringFormat='{}{0:F0}px'}" Foreground="White"/>
                            </Grid>
                            <Slider Minimum="0" 
                                    Maximum="200" 
                                    Value="{Binding PreviewPadding}"
                                    Background="#374151"/>
                        </StackPanel>

                        <!-- Padding Slider -->
                        <StackPanel Spacing="8">
                            <Grid ColumnDefinitions="*,Auto">
                                <TextBlock Grid.Column="0" Text="Padding" Foreground="#9CA3AF"/>
                                <TextBlock Grid.Column="1" Text="{Binding SmartPadding, StringFormat='{}{0:F0}px'}" Foreground="White"/>
                            </Grid>
                            <Slider Minimum="0" 
                                    Maximum="200" 
                                    Value="{Binding SmartPadding}"
                                    Background="#374151"/>
                            <!-- Smart Padding Checkbox -->
                            <CheckBox IsChecked="{Binding UseSmartPadding}"
                                      Foreground="#9CA3AF"
                                      Content="Smart Padding"/>
                        </StackPanel>

                        <!-- Rounded Corner Slider -->
                        <StackPanel Spacing="8">
                            <Grid ColumnDefinitions="*,Auto">
                                <TextBlock Grid.Column="0" Text="Rounded Corner" Foreground="#9CA3AF"/>
                                <TextBlock Grid.Column="1" Text="{Binding PreviewCornerRadius, StringFormat='{}{0:F0}px'}" Foreground="White"/>
                            </Grid>
                            <Slider Minimum="0" 
                                    Maximum="50" 
                                    Value="{Binding PreviewCornerRadius}"
                                    Background="#374151"/>
                        </StackPanel>

                        <!-- Shadow Slider -->
                        <StackPanel Spacing="8">
                            <Grid ColumnDefinitions="*,Auto">
                                <TextBlock Grid.Column="0" Text="Shadow" Foreground="#9CA3AF"/>
                                <TextBlock Grid.Column="1" Text="{Binding ShadowBlur, StringFormat='{}{0:F0}px'}" Foreground="White"/>
                            </Grid>
                            <Slider Minimum="0" 
                                    Maximum="100" 
                                    Value="{Binding ShadowBlur}"
                                    Background="#374151"/>
                        </StackPanel>

                        <!-- Output Ratio -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="Output Ratio" Foreground="#9CA3AF"/>
                            <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="*,*,*">
                                <Grid.Styles>
                                    <Style Selector="Button">
                                        <Setter Property="Margin" Value="2"/>
                                    </Style>
                                </Grid.Styles>
                                
                                <!-- Row 0 -->
                                <Button Grid.Row="0" Grid.Column="0" Content="Auto"
                                        Classes="ratio-button"
                                        Command="{Binding SetOutputRatioCommand}" CommandParameter="Auto"
                                        Classes.active="{Binding SelectedOutputRatio, Converter={StaticResource EqualsConverter}, ConverterParameter=Auto}"
                                        HorizontalAlignment="Stretch" VerticalAlignment="Stretch"/>
                                <Button Grid.Row="0" Grid.Column="1" Content="1:1"
                                        Classes="ratio-button"
                                        Command="{Binding SetOutputRatioCommand}" CommandParameter="1:1"
                                        Classes.active="{Binding SelectedOutputRatio, Converter={StaticResource EqualsConverter}, ConverterParameter=1:1}"
                                        HorizontalAlignment="Stretch" VerticalAlignment="Stretch"/>
                                <Button Grid.Row="0" Grid.Column="2" Content="4:3"
                                        Classes="ratio-button"
                                        Command="{Binding SetOutputRatioCommand}" CommandParameter="4:3"
                                        Classes.active="{Binding SelectedOutputRatio, Converter={StaticResource EqualsConverter}, ConverterParameter=4:3}"
                                        HorizontalAlignment="Stretch" VerticalAlignment="Stretch"/>
                                
                                <!-- Row 1 -->
                                <Button Grid.Row="1" Grid.Column="0" Content="3:2"
                                        Classes="ratio-button"
                                        Command="{Binding SetOutputRatioCommand}" CommandParameter="3:2"
                                        Classes.active="{Binding SelectedOutputRatio, Converter={StaticResource EqualsConverter}, ConverterParameter=3:2}"
                                        HorizontalAlignment="Stretch" VerticalAlignment="Stretch"/>
                                <Button Grid.Row="1" Grid.Column="1" Content="16:9"
                                        Classes="ratio-button"
                                        Command="{Binding SetOutputRatioCommand}" CommandParameter="16:9"
                                        Classes.active="{Binding SelectedOutputRatio, Converter={StaticResource EqualsConverter}, ConverterParameter=16:9}"
                                        HorizontalAlignment="Stretch" VerticalAlignment="Stretch"/>
                                <Button Grid.Row="1" Grid.Column="2" Content="5:3"
                                        Classes="ratio-button"
                                        Command="{Binding SetOutputRatioCommand}" CommandParameter="5:3"
                                        Classes.active="{Binding SelectedOutputRatio, Converter={StaticResource EqualsConverter}, ConverterParameter=5:3}"
                                        HorizontalAlignment="Stretch" VerticalAlignment="Stretch"/>
                                
                                <!-- Row 2 -->
                                <Button Grid.Row="2" Grid.Column="0" Content="9:16"
                                        Classes="ratio-button"
                                        Command="{Binding SetOutputRatioCommand}" CommandParameter="9:16"
                                        Classes.active="{Binding SelectedOutputRatio, Converter={StaticResource EqualsConverter}, ConverterParameter=9:16}"
                                        HorizontalAlignment="Stretch" VerticalAlignment="Stretch"/>
                                <Button Grid.Row="2" Grid.Column="1" Content="3:4"
                                        Classes="ratio-button"
                                        Command="{Binding SetOutputRatioCommand}" CommandParameter="3:4"
                                        Classes.active="{Binding SelectedOutputRatio, Converter={StaticResource EqualsConverter}, ConverterParameter=3:4}"
                                        HorizontalAlignment="Stretch" VerticalAlignment="Stretch"/>
                                <Button Grid.Row="2" Grid.Column="2" Content="2:3"
                                        Classes="ratio-button"
                                        Command="{Binding SetOutputRatioCommand}" CommandParameter="2:3"
                                        Classes.active="{Binding SelectedOutputRatio, Converter={StaticResource EqualsConverter}, ConverterParameter=2:3}"
                                        HorizontalAlignment="Stretch" VerticalAlignment="Stretch"/>
                            </Grid>
                        </StackPanel>

                        <!-- Background -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="Background" Foreground="#9CA3AF"/>
                            <ItemsControl ItemsSource="{Binding GradientPresets}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Orientation="Horizontal" />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Button Padding="0" BorderThickness="0" Background="Transparent" Margin="2"
                                                Command="{Binding DataContext.ApplyGradientPresetCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding}">
                                            <Border Width="50" Height="50" CornerRadius="10" Background="{Binding Brush}" ToolTip.Tip="{Binding Name}"/>
                                        </Button>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>

                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>

        <!-- Row 2: Combined Bottom Bar (Export + Zoom Controls) -->
        <Border Grid.Row="2" Padding="16,8">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <!-- Left: Export Actions -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                    <Button Classes="ratio-button" Command="{Binding CopyCommand}" Height="36" Padding="16,0">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="{StaticResource IconCopy}" FontSize="16" FontFamily="{StaticResource FontAwesome}" FontWeight="Black"/>
                            <TextBlock Text="Copy" FontSize="14"/>
                        </StackPanel>

                    </Button>
                    
                    <Button Classes="ratio-button" Command="{Binding QuickSaveCommand}" Height="36" Padding="16,0">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="{StaticResource IconDownload}" FontSize="16" FontFamily="{StaticResource FontAwesome}" FontWeight="Black"/>
                            <TextBlock Text="Save" FontSize="14"/>
                        </StackPanel>

                    </Button>
                    
                    <Button Classes="ratio-button" Command="{Binding SaveAsCommand}" Height="36" Padding="16,0">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="{StaticResource IconSave}" FontSize="16" FontFamily="{StaticResource FontAwesome}" FontWeight="Black"/>
                            <TextBlock Text="Save As..." FontSize="14"/>
                        </StackPanel>

                    </Button>
                    
                    <Button Classes="ratio-button" Command="{Binding UploadCommand}" Height="36" Padding="16,0">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="&#xf093;" FontSize="16" FontFamily="{StaticResource FontAwesome}" FontWeight="Black"/>
                            <TextBlock Text="Upload" FontSize="14"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
                
                <!-- Center: Empty spacer -->
                <Border Grid.Column="1"/>
                
                <!-- Right: Zoom Controls -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="6" VerticalAlignment="Center">
                    <Button Classes="ratio-button" Height="36"
                            Padding="12,0"
                            Command="{Binding ZoomOutCommand}" ToolTip.Tip="Zoom out (Ctrl + Wheel)"
                            FontFamily="{StaticResource FontAwesome}" FontWeight="Black" FontSize="14" Content="{StaticResource IconZoomOut}"/>
                    <Slider Width="140"
                            Minimum="0.25" Maximum="4"
                            SmallChange="0.1" LargeChange="0.25"
                            Value="{Binding Zoom}"
                            VerticalAlignment="Center"/>
                    <Button Classes="ratio-button" Height="36"
                            Padding="12,0"
                            Command="{Binding ZoomInCommand}" ToolTip.Tip="Zoom in (Ctrl + Wheel)"
                            FontFamily="{StaticResource FontAwesome}" FontWeight="Black" FontSize="14" Content="{StaticResource IconZoomIn}"/>
                    <Button Classes="ratio-button" Height="36"
                            Padding="12,0"
                            Command="{Binding ResetZoomCommand}" ToolTip.Tip="Reset zoom">
                        <TextBlock Text="100%" FontSize="12" FontWeight="SemiBold" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Button>
                    <TextBlock Text="{Binding Zoom, StringFormat='{}{0:P0}'}" 
                               Foreground="#E2E8F0"
                               FontSize="12"
                               VerticalAlignment="Center"
                               Margin="4,0,0,0"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Effects Panel Overlay (Grid.RowSpan=3 to cover entire view) -->
        <Border Grid.Row="0" Grid.RowSpan="3"
                IsVisible="{Binding IsEffectsPanelOpen}"
                Background="#80000000"
                HorizontalAlignment="Right"
                VerticalAlignment="Stretch"
                Width="400"
                Padding="16">
            <views:EffectsPanelView DataContext="{Binding EffectsPanel}"
                                    ApplyRequested="OnEffectsPanelApplyRequested"/>
        </Border>
    </Grid>
</UserControl>
